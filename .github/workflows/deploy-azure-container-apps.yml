name: Deploy to Azure Container Apps

on:
  push:
    branches: [ main ]
    tags: [ 'v*.*.*' ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '8.0.x'
  REGISTRY_NAME: ${{ secrets.ACR_LOGIN_SERVER }}
  IMAGE_NAME: warranty-api
  RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
  CONTAINER_APP_NAME: warranty-api
  CONTAINER_APP_ENV: warranty-app-env

jobs:
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Log in to Azure Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ secrets.ACR_LOGIN_SERVER }}
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}
        
    - name: Extract version from tag
      id: version
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        else
          echo "VERSION=$(date +%Y%m%d%H%M%S)-${GITHUB_SHA::8}" >> $GITHUB_OUTPUT
        fi
        
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: ./MyAspireSolution
        file: ./MyAspireSolution/MyApi/Dockerfile
        push: true
        tags: |
          ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.VERSION }}
          ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:latest
    
    outputs:
      image-tag: ${{ steps.version.outputs.VERSION }}

  deploy:
    name: Deploy to Azure Container Apps
    runs-on: ubuntu-latest
    needs: build-and-push
    environment:
      name: production
      url: https://warranty-api.azurecontainerapps.io
    
    steps:
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: Deploy to Azure Container Apps
      uses: azure/container-apps-deploy-action@v1
      with:
        resourceGroup: ${{ env.RESOURCE_GROUP }}
        containerAppName: ${{ env.CONTAINER_APP_NAME }}
        containerAppEnvironment: ${{ env.CONTAINER_APP_ENV }}
        imageToDeploy: ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ needs.build-and-push.outputs.image-tag }}
        targetPort: 8080
        ingress: external
        environmentVariables: |
          JWT__SECRET=secretref:jwt-secret
          JWT__ISSUER=WarrantyApp
          JWT__AUDIENCE=WarrantyAppUsers
          JWT__EXPIRYINMINUTES=60
          OPENAI__APIKEY=secretref:openai-api-key
          SMTP__HOST=secretref:smtp-host
          SMTP__PORT=secretref:smtp-port
          SMTP__USERNAME=secretref:smtp-username
          SMTP__PASSWORD=secretref:smtp-password
          SMTP__FROMEMAIL=secretref:smtp-from-email
          TWILIO__ACCOUNTSID=secretref:twilio-account-sid
          TWILIO__AUTHTOKEN=secretref:twilio-auth-token
          TWILIO__PHONENUMBER=secretref:twilio-phone-number
        secrets: |
          jwt-secret=${{ secrets.JWT_SECRET }}
          openai-api-key=${{ secrets.OPENAI_API_KEY }}
          smtp-host=${{ secrets.SMTP_HOST }}
          smtp-port=${{ secrets.SMTP_PORT }}
          smtp-username=${{ secrets.SMTP_USERNAME }}
          smtp-password=${{ secrets.SMTP_PASSWORD }}
          smtp-from-email=${{ secrets.SMTP_FROM_EMAIL }}
          twilio-account-sid=${{ secrets.TWILIO_ACCOUNT_SID }}
          twilio-auth-token=${{ secrets.TWILIO_AUTH_TOKEN }}
          twilio-phone-number=${{ secrets.TWILIO_PHONE_NUMBER }}
          
    - name: Verify deployment
      run: |
        echo "Waiting for deployment to stabilize..."
        sleep 30
        
        # Get the FQDN
        FQDN=$(az containerapp show \
          --name ${{ env.CONTAINER_APP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --query properties.configuration.ingress.fqdn \
          --output tsv)
        
        echo "Application URL: https://$FQDN"
        
        # Health check
        if curl -f "https://$FQDN/health"; then
          echo "‚úÖ Deployment successful - health check passed"
        else
          echo "‚ùå Deployment failed - health check failed"
          exit 1
        fi
        
    - name: Azure logout
      run: az logout
      if: always()

  post-deployment:
    name: Post-Deployment Tasks
    runs-on: ubuntu-latest
    needs: deploy
    if: success()
    
    steps:
    - name: Notify deployment success
      run: |
        echo "üéâ Deployment to production completed successfully!"
        echo "Image: ${{ needs.build-and-push.outputs.image-tag }}"
        echo "Commit: ${{ github.sha }}"
        
    # Optional: Send notification to Slack, Teams, etc.
    # - name: Notify Slack
    #   uses: 8398a7/action-slack@v3
    #   with:
    #     status: ${{ job.status }}
    #     text: 'Warranty App deployed to production'
    #     webhook_url: ${{ secrets.SLACK_WEBHOOK }}
